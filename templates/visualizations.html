{% extends 'base.html' %}
{% block title %}3D Visualizations · nanozyme-lite{% endblock %}

{% block content %}
<div class="container py-4">

  <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between mb-3">
    <div>
      <h1 class="h4 mb-1">3D Visualizations</h1>
      <p class="text-muted mb-0">Browse interactive PCA / Scatter / Surface plots exported as HTML</p>
    </div>
    <div class="mt-3 mt-md-0 d-flex align-items-center gap-2">
      <span class="badge bg-secondary" id="vizCount">
        {% if plot_embeds %}{{ plot_embeds|length }} plots{% else %}0 plots{% endif %}
      </span>
      <a class="btn btn-outline-secondary" href="{{ url_for('home.index') }}">Back to home</a>
    </div>
  </div>

  {% if not plot_embeds %}
    <div class="alert alert-warning">No 3D plots found in <code>static/embeds/</code>.</div>
  {% else %}
  <div class="row g-3">
    <!-- Left: list -->
    <div class="col-lg-4">
      <div class="input-group input-group-sm mb-3">
        <span class="input-group-text">Filter</span>
        <input id="vizFilter" type="text" class="form-control" placeholder="Type to filter filenames">
      </div>
      <div id="vizList" class="list-group small" role="listbox" aria-label="3D plot list">
        {% for fname in plot_embeds %}
          <a href="#"
             class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
             data-src="{{ url_for('static', filename='embeds/' ~ fname) }}"
             data-fname="{{ fname | e }}"
             data-index="{{ loop.index0 }}">
             <span>{{ fname }}</span>
             <span class="badge bg-light text-dark">{{ loop.index }}</span>
          </a>
        {% endfor %}
      </div>
    </div>

    <!-- Right: viewer -->
    <div class="col-lg-8">
      <div class="ratio ratio-16x9 border rounded overflow-hidden">
        <iframe id="vizFrame" src="" loading="lazy" referrerpolicy="no-referrer" style="border:0;" title="3D plot preview"></iframe>
      </div>

      <div class="d-flex align-items-center justify-content-between mt-2">
        <div class="small text-muted" id="vizCaption" aria-live="polite">—</div>
        <div class="d-flex gap-2">
          <button type="button" class="btn btn-outline-secondary btn-sm" id="prevPlot" aria-label="Previous">← Prev</button>
          <button type="button" class="btn btn-outline-secondary btn-sm" id="nextPlot" aria-label="Next">Next →</button>
          <a id="openNewTab" href="#" target="_blank" class="btn btn-outline-primary btn-sm" rel="noopener">Open in new tab</a>
          <button id="copyLinkBtn" class="btn btn-secondary btn-sm" type="button">Copy link</button>
        </div>
      </div>
      <div class="small text-muted mt-1">Tips: Use ← / → to switch, Enter to open in new tab.</div>
    </div>
  </div>
  {% endif %}

</div>
{% endblock %}

{% block body_extra %}
<style>
  #vizList .list-group-item{ border-radius:10px; margin-bottom:.5rem; }
  #vizList .list-group-item.active{
    background: linear-gradient(135deg,#3b82f6,#8b5cf6);
    border-color: transparent; color:#fff;
  }
  #vizFrame { outline: 1px solid rgba(0,0,0,.06); }
</style>

<script>
  // Build names from server without tojson
  const PLOT_EMBEDS = [
  {% for fname in plot_embeds|default([]) %}
    "{{ fname | e }}"{% if not loop.last %},{% endif %}
  {% endfor %}
  ];

  function selectByIndex(idx){
    const list = document.getElementById('vizList');
    const items = list.querySelectorAll('a.list-group-item');
    if(items.length === 0) return;
    const i = (idx + items.length) % items.length; // wrap
    items[i].click();
  }

  function updateURL(fname){
    const url = new URL(window.location.href);
    url.searchParams.set('f', fname);
    url.searchParams.delete('i');
    url.hash = fname;
    history.replaceState(null, '', url.toString());
  }

  function readInitialTarget(){
    const url = new URL(window.location.href);
    const byF = url.searchParams.get('f') || (window.location.hash ? window.location.hash.substring(1) : '');
    if(byF){
      const idx = PLOT_EMBEDS.indexOf(byF);
      if(idx >= 0) return {type:'fname', value: byF, index: idx};
    }
    const byI = url.searchParams.get('i');
    if(byI && !Number.isNaN(parseInt(byI,10))){
      const i = Math.max(0, Math.min(PLOT_EMBEDS.length-1, parseInt(byI,10)));
      return {type:'index', value: i, index: i};
    }
    return {type:'index', value: 0, index: 0};
  }

  function installFilter(){
    const input = document.getElementById('vizFilter');
    const list = document.getElementById('vizList');
    if(!input || !list) return;
    input.addEventListener('input', () => {
      const kw = input.value.toLowerCase().trim();
      let firstVisible = null;
      list.querySelectorAll('a.list-group-item').forEach((a) => {
        const show = a.dataset.fname.toLowerCase().includes(kw);
        a.style.display = show ? '' : 'none';
        if(show && !firstVisible) firstVisible = a;
      });
      const active = list.querySelector('a.active');
      if(active && active.style.display !== 'none') return;
      if(firstVisible) firstVisible.click();
    });
  }

  function copyLink(currentFname){
    const url = new URL(window.location.href);
    url.searchParams.set('f', currentFname);
    url.hash = currentFname;
    navigator.clipboard.writeText(url.toString()).then(()=>{
      const btn = document.getElementById('copyLinkBtn');
      if(btn){ const old = btn.textContent; btn.textContent = 'Copied!'; setTimeout(()=>btn.textContent=old, 900); }
    });
  }

  document.addEventListener('DOMContentLoaded', () => {
    const list = document.getElementById('vizList');
    const frame = document.getElementById('vizFrame');
    const caption = document.getElementById('vizCaption');
    const prevBtn = document.getElementById('prevPlot');
    const nextBtn = document.getElementById('nextPlot');
    const openNew = document.getElementById('openNewTab');
    const copyBtn = document.getElementById('copyLinkBtn');

    if(!list) return;

    // attach click handlers
    list.querySelectorAll('a.list-group-item').forEach((a) => {
      a.addEventListener('click', (e) => {
        e.preventDefault();
        [...list.querySelectorAll('.active')].forEach(el=>el.classList.remove('active'));
        a.classList.add('active');
        frame.src = a.dataset.src;
        caption.textContent = a.dataset.fname;
        openNew.href = a.dataset.src;
        updateURL(a.dataset.fname);
      });
    });

    // keyboard navigation
    function keyHandler(e){
      const active = list.querySelector('a.active');
      const idx = active ? parseInt(active.dataset.index, 10) : 0;
      if(e.key === 'ArrowLeft'){ e.preventDefault(); selectByIndex(idx - 1); }
      else if(e.key === 'ArrowRight'){ e.preventDefault(); selectByIndex(idx + 1); }
      else if(e.key === 'Enter'){
        if(openNew && openNew.href) window.open(openNew.href, '_blank', 'noopener');
      }
    }
    document.addEventListener('keydown', keyHandler);

    // prev/next buttons
    prevBtn?.addEventListener('click', () => {
      const active = list.querySelector('a.active');
      const idx = active ? parseInt(active.dataset.index, 10) : 0;
      selectByIndex(idx - 1);
    });
    nextBtn?.addEventListener('click', () => {
      const active = list.querySelector('a.active');
      const idx = active ? parseInt(active.dataset.index, 10) : 0;
      selectByIndex(idx + 1);
    });

    // copy link
    copyBtn?.addEventListener('click', () => {
      const active = list.querySelector('a.active');
      const fname = active ? active.dataset.fname : (PLOT_EMBEDS[0] || '');
      if(fname) copyLink(fname);
    });

    // filter
    installFilter();

    // initial selection
    const init = readInitialTarget();
    if(init.type === 'fname'){
      const target = list.querySelector(`a[data-fname="${CSS.escape(init.value)}"]`);
      if(target) target.click(); else selectByIndex(init.index);
    } else {
      selectByIndex(init.index);
    }
  });
</script>
{% endblock %}
